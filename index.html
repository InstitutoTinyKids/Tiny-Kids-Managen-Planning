<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tiny Kids Manager Cloud</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- SDK DE SUPABASE -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* --- ESTILOS BASE --- */
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
            --text: #334155;
            --sidebar-width: 280px;
            --baby-color: #f43f5e; 
            --baby-bg: #fff1f2;
            --baby-border: #fecdd3;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            --hover-transform: translateY(-3px);
            --status-pending: #fbbf24;
            --status-process: #3b82f6;
            --status-done: #10b981;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; 
            margin: 0; padding: 0; 
            background-color: var(--bg); color: var(--text); 
            display: flex; height: 100vh; overflow: hidden; 
        }
        
        /* Layout */
        nav { 
            width: var(--sidebar-width); background: white; border-right: 1px solid #e2e8f0; 
            display: flex; flex-direction: column; padding: 1.5rem; flex-shrink: 0; z-index: 1000; 
            height: 100vh; overflow-y: auto; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        nav h1 { font-size: 1.4rem; color: var(--primary); margin: 0 0 0.5rem 0; display: flex; align-items: center; gap: 0.5rem; }
        
        #backup-indicator { display: none; color: #ef4444; font-size: 0.8rem; font-weight: bold; margin-bottom: 2rem; padding-left: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .program-label { font-size: 0.75rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.5rem; font-weight: 700; padding: 0 1rem; }
        nav a { display: flex; align-items: center; padding: 0.75rem 1rem; color: #64748b; text-decoration: none; border-radius: 0.5rem; margin-bottom: 0.5rem; font-weight: 500; transition: all 0.2s; cursor: pointer; }
        nav a:hover { background-color: #f1f5f9; color: var(--primary); }
        nav a.active { background-color: var(--baby-bg); color: var(--baby-color); font-weight: bold; }
        nav a i { width: 24px; margin-right: 10px; }
        
        main { flex-grow: 1; display: flex; flex-direction: column; background: #f8fafc; overflow: hidden; position: relative; }
        
        .top-bar { 
            background: white; padding: 1rem 2rem; border-bottom: 1px solid #e2e8f0; 
            display: flex; align-items: center; gap: 1rem; flex-shrink: 0; min-height: 70px; 
            justify-content: space-between; z-index: 10;
        }
        
        .back-btn { border: 1px solid #cbd5e1; background: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #475569; transition: all 0.2s; flex-shrink: 0; }
        .back-btn:disabled { opacity: 0.3; cursor: default; }
        .breadcrumbs { font-size: 0.9rem; color: #64748b; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .content-scroll { flex-grow: 1; overflow-y: auto; padding: 2rem 1.5rem; position: relative; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; }

        .dashboard-section-title { font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; color: #94a3b8; font-weight: 700; margin-bottom: 1rem; display: flex; align-items: center; gap: 10px; }
        .dashboard-section-title::after { content: ''; flex-grow: 1; height: 1px; background: #e2e8f0; }
        
        .objectives-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 3rem; }
        .obj-card { background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; border-top: 4px solid var(--baby-color); cursor: pointer; transition: all 0.2s; position: relative; }
        .obj-badge { font-size: 0.7rem; font-weight: bold; color: var(--baby-color); background: var(--baby-bg); padding: 3px 8px; border-radius: 12px; }
        .obj-text { font-size: 1rem; font-weight: 600; color: #1e293b; margin-top: 0.8rem; line-height: 1.4; }
        
        .weeks-row { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1.5rem; }
        .week-btn-large { background: white; border: 2px solid #e2e8f0; border-radius: 16px; padding: 2rem 1.5rem; text-align: center; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 140px; position: relative; }
        .wb-icon { font-size: 2rem; color: #cbd5e1; margin-bottom: 0.5rem; }
        .wb-title { font-size: 1.2rem; font-weight: 800; color: #1e293b; }
        .wb-sub { font-size: 0.85rem; color: #64748b; margin-top: 5px; }

        /* MODAL - ALINEACIÓN SUPERIOR */
        .modal-overlay { 
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background:rgba(0,0,0,0.5); z-index:2000; 
            display:none; 
            justify-content:center; 
            align-items:flex-start; 
            padding-top: 2rem; 
            backdrop-filter: blur(2px); 
        }
        .modal-overlay.open { display:flex; }
        .modal { 
            background:white; width:95%; max-width:700px; padding:1.5rem; 
            border-radius:12px; max-height:90vh; 
            overflow-y:auto; 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); 
        }
        .form-group { margin-bottom:1rem; text-align: left; }
        .label { display:block; font-size:0.8rem; font-weight:700; color:#64748b; margin-bottom:5px; text-transform:uppercase; }
        .input, .select { width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:6px; font-family:inherit; font-size: 1rem; } 

        #loader { position: fixed; top:0; left:0; right:0; bottom:0; background:white; z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction:column; }
        .spinner { width:40px; height:40px; border:4px solid #f3f3f3; border-top:4px solid var(--primary); border-radius:50%; animation:spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .save-toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: #334155; color: white; padding: 10px 20px; border-radius: 30px;
            font-size: 0.9rem; opacity: 0; transition: opacity 0.3s; z-index: 5000;
        }
        .save-toast.show { opacity: 1; }

        /* STATUS BADGES SELECTOR */
        .status-selector { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
        .status-btn { padding: 6px 12px; border-radius: 20px; border: 1px solid #e2e8f0; cursor: pointer; font-size: 0.8rem; font-weight: bold; background: white; transition: all 0.2s; opacity: 0.6; min-height: 36px; display:flex; align-items:center; }
        .status-btn.active { opacity: 1; border-color: transparent; color: white; }
        .status-btn[data-val="Pendiente"].active { background: var(--status-pending); }
        .status-btn[data-val="En Proceso"].active { background: var(--status-process); }
        .status-btn[data-val="Creado"].active { background: var(--status-done); }

        /* --- EDITOR TEXTO RICO --- */
        .toolbar { display:flex; gap:5px; background:#f1f5f9; padding:5px; border-radius:6px 6px 0 0; border:1px solid #cbd5e1; border-bottom:none; flex-wrap: wrap; align-items: center;}
        .tool-btn { border:1px solid #e2e8f0; background:white; cursor:pointer; padding:6px 10px; border-radius:4px; font-weight:bold; min-height: 36px; }
        .editor-box { min-height:150px; border:1px solid #cbd5e1; padding:10px; border-radius:0 0 6px 6px; background:white; overflow-y: auto; font-size: 1rem; }

        .btn-mini { border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; background: #f1f5f9; color: #64748b; }
        .btn-mini:hover { background: #e2e8f0; color: var(--primary); }

        @media (max-width: 768px) {
            nav { position: fixed; left: 0; transform: translateX(-100%); width: 85%; }
            nav.active { transform: translateX(0); }
            .content-scroll { padding: 1rem; }
        }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner"></div>
    <p style="margin-top:10px; color:#64748b;">Sincronizando con Supabase...</p>
</div>

<div id="save-toast" class="save-toast">Guardado en la Nube</div>

<div class="modal-overlay" id="editor-modal">
    <div class="modal">
        <h2 id="modal-title" style="margin-top:0;">Editar</h2>
        <div id="modal-body"></div>
        <div style="margin-top:20px; text-align:right;">
            <button class="back-btn" style="width:auto; padding:10px 20px; border-radius:8px; display:inline-block;" onclick="closeModal()">Cancelar</button>
            <button class="back-btn" style="width:auto; padding:10px 20px; border-radius:8px; display:inline-block; background:var(--primary); color:white; border:none;" id="modal-save-btn">Guardar</button>
        </div>
    </div>
</div>

<nav id="sidebar">
    <h1><i class="fas fa-shapes"></i> TK Cloud</h1>
    <div id="backup-indicator">(Solo Lectura)</div>
    <a href="#" onclick="showHome()"><i class="fas fa-home"></i> Inicio / Config</a>
    <div class="program-label">PROGRAMAS</div>
    <a href="#" id="link-baby" onclick="switchProgram('Baby Program', this)"><i class="fas fa-baby"></i> Baby Program</a>
    <a href="#" onclick="switchProgram('Tiny Program', this)"><i class="fas fa-child"></i> Tiny Program</a>
    <a href="#" onclick="switchProgram('Mini Program', this)"><i class="fas fa-child-reaching"></i> Mini Program</a>
    <a href="#" onclick="switchProgram('Big Program', this)"><i class="fas fa-user-graduate"></i> Big Program</a>
</nav>

<main>
    <div class="top-bar">
        <div style="display:flex; gap:10px; align-items:center;">
            <button class="back-btn" onclick="toggleMenu()" id="btn-menu"><i class="fas fa-bars"></i></button>
            <button id="btn-back" class="back-btn" onclick="goBack()" disabled><i class="fas fa-arrow-left"></i></button>
        </div>
        <button class="back-btn hide-on-backup" style="width:auto; padding:8px 16px; border-radius:6px; background:#10b981; color:white; border:none;" onclick="saveToCloud()">Guardar Todo</button>
        <div class="breadcrumbs" id="breadcrumbs">Dashboard</div>
    </div>

    <div class="content-scroll">
        <!-- VISTA HOME -->
        <div id="view-home" class="view-layer active">
             <div style="max-width:500px; margin: 2rem auto; background:white; padding:2rem; border-radius:12px; border:1px solid #e2e8f0; text-align:center;">
                 <h2 style="margin-top:0;">Gestión de Periodos</h2>
                 <div class="form-group">
                     <label class="label">Mes</label>
                     <select class="select" id="cfg-month">
                         <option>Enero</option><option>Febrero</option><option>Marzo</option><option>Abril</option><option>Mayo</option><option>Junio</option><option>Julio</option><option>Agosto</option><option>Septiembre</option><option>Octubre</option><option>Noviembre</option><option>Diciembre</option>
                     </select>
                 </div>
                 <div class="form-group">
                     <label class="label">Año</label>
                     <select class="select" id="cfg-year"></select>
                 </div>
                 <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-top:1.5rem;">
                     <button class="back-btn" style="width:auto; height:50px; background:var(--primary); color:white; border:none; border-radius:8px;" onclick="clickLoad()">Cargar</button>
                     <button class="back-btn" style="width:auto; height:50px; border-radius:8px;" onclick="clickCreate()">Crear</button>
                     <button class="back-btn" style="width:auto; height:50px; border-radius:8px; background:#64748b; color:white; border:none;" onclick="exportBackup()">Respaldo</button>
                 </div>
             </div>
        </div>

        <!-- VISTA DASHBOARD -->
        <div id="view-dashboard" class="view-layer">
            <div style="text-align: center; margin-bottom:2rem;">
                <div style="display:flex; align-items:center; justify-content:center; gap:10px;">
                    <h2 id="dash-theme-display" style="margin:0; color:var(--primary);">...</h2>
                    <button class="btn-mini" onclick="editThemeName()"><i class="fas fa-pen"></i></button>
                </div>
                <div id="dash-period-display" style="color:#64748b; font-size:0.9rem;">...</div>
            </div>
            <div class="dashboard-section-title"><i class="fas fa-bullseye"></i> Objetivos del Mes</div>
            <div class="objectives-row" id="objectives-container"></div>
            <div class="dashboard-section-title"><i class="far fa-calendar-alt"></i> Planificación Semanal</div>
            <div class="weeks-row" id="weeks-container"></div>
        </div>

        <!-- VISTA GRUPOS -->
        <div id="view-groups" class="view-layer">
            <div style="margin-bottom:2rem;">
                <h1 id="groups-week-title" style="margin-bottom:0.2rem;">...</h1>
                <p id="groups-week-obj" style="color:#64748b; margin:0;"></p>
                <button class="back-btn" style="width:auto; border:none; background:none; color:var(--primary); padding:0; height:auto; margin-top:5px; font-weight:bold;" onclick="editWeek()">Editar Info Semana</button>
            </div>
            
            <div class="dashboard-section-title">Contenido Académico</div>
            <div id="academic-grid-container" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:1rem; margin-bottom:1rem;"></div>
            <button class="back-btn hide-on-backup" style="width:100%; border-radius:8px; border:2px dashed #cbd5e1; height:50px;" onclick="addAcademicContent()">+ Agregar Contenido</button>
            
            <div class="dashboard-section-title" style="margin-top:2rem;">Grupos / Horarios</div>
            <div id="groups-list-container"></div>
            <button class="back-btn hide-on-backup" style="width:100%; border-radius:8px; height:60px; margin-top:1rem;" onclick="addGroup()">+ Agregar Nuevo Grupo</button>
        </div>

        <!-- VISTA ACTIVIDADES -->
        <div id="view-activities" class="view-layer">
            <div style="margin-bottom:1.5rem;">
                <h2 id="act-group-name" style="color:var(--primary); margin-bottom:0.2rem;">...</h2>
                <div id="act-meta-info" style="color:#64748b; font-size:0.9rem;"></div>
            </div>
            <div id="activities-container"></div>
            <button class="back-btn hide-on-backup" style="width:100%; border-radius:8px; height:60px; margin-top:1rem;" onclick="addActivity()">+ Nueva Actividad</button>
        </div>

        <!-- VISTA DETALLE ACTIVIDAD -->
        <div id="view-activity-detail" class="view-layer">
            <div style="background:white; border-radius:12px; padding:2rem; border:1px solid #e2e8f0; position:relative;">
                <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:1rem;">
                    <div id="det-num-badge" class="obj-badge">ACTIVIDAD</div>
                    <button class="btn-mini" onclick="editActivity()"><i class="fas fa-pen"></i></button>
                </div>
                <h1 id="det-title" style="margin: 0.5rem 0 1rem 0; font-size:2rem; color:#1e293b;">...</h1>
                <div id="det-pilar-display" style="font-weight:bold; color:var(--baby-color); font-size:1.1rem; margin-bottom:1.5rem;">...</div>
                
                <div id="det-desc" style="line-height:1.8; color:#334155;"></div>
                
                <div style="background:#f8fafc; padding:1.5rem; border-radius:10px; border:1px solid #e2e8f0; margin-top:2rem;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                        <h4 style="margin:0;"><i class="fas fa-toolbox"></i> Recursos y Materiales</h4>
                        <div id="det-res-type-badge" style="font-size:0.75rem; background:#dbeafe; color:#1e40af; padding:4px 10px; border-radius:15px; font-weight:bold;">Type</div>
                    </div>
                    <div id="det-res-content"></div>
                    
                    <div style="margin-top:1.5rem; border-top:1px dashed #cbd5e1; padding-top:1rem;">
                        <div class="label" style="margin-bottom:10px;">Estado del Recurso</div>
                        <div class="status-selector" id="det-status-container"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    // --- SUPABASE ---
    const supabaseUrl = 'https://qseuraogholnhrzqoysa.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFzZXVyYW9naG9sbmhyenFveXNhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0OTY1NzQsImV4cCI6MjA4NDA3MjU3NH0.P2c-Nqw03ZNenZ7eQmcBzIhQQvN45X0VkavFC35i4uw';
    const sb = supabase.createClient(supabaseUrl, supabaseKey);

    let globalDB = {};
    let currentPeriodKey = "";
    let currentProgram = "Baby Program";
    let db = null; 
    let navStack = [];
    let currentWeekId, currentGroupId, currentActId;

    /* BACKUP_DATA_INJECTION */

    window.onload = async function() {
        populateYears();
        
        if (window.isBackupMode && window.backupData) {
            globalDB = window.backupData;
            document.getElementById('backup-indicator').style.display = 'block';
            document.body.classList.add('backup-mode');
        } else {
            await loadFromSupabase();
        }
        
        document.getElementById('loader').style.display='none';
        showHome();
    };

    function populateYears() {
        const yearSelect = document.getElementById('cfg-year');
        const cy = new Date().getFullYear();
        for(let i = cy - 1; i <= cy + 3; i++) {
            const opt = document.createElement('option');
            opt.value = opt.innerHTML = i;
            if(i === cy) opt.selected = true;
            yearSelect.appendChild(opt);
        }
    }

    async function loadFromSupabase() {
        try {
            const { data, error } = await sb.from('periods').select('*');
            if (error) throw error;
            globalDB = {};
            data.forEach(row => globalDB[row.id] = row.data);
        } catch (err) { console.error("Error cargando:", err); }
    }

    async function saveToCloud() {
        if(window.isBackupMode || !currentPeriodKey || !globalDB[currentPeriodKey]) return;
        const toast = document.getElementById('save-toast');
        try {
            const { error } = await sb.from('periods').upsert({ id: currentPeriodKey, data: globalDB[currentPeriodKey] });
            if (error) throw error;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        } catch (err) { alert("Error al guardar en la nube: " + err.message); }
    }

    // --- NAVEGACIÓN ---
    window.showHome = () => {
        document.querySelectorAll('.view-layer').forEach(l => l.classList.remove('active'));
        document.getElementById('view-home').classList.add('active');
        navStack = [];
        document.getElementById('btn-back').disabled = true;
        document.getElementById('breadcrumbs').innerText = "Inicio";
    };

    window.clickLoad = () => {
        const key = `${document.getElementById('cfg-month').value}-${document.getElementById('cfg-year').value}`;
        if(!globalDB[key]) return alert("No hay datos para este periodo. Por favor crea uno nuevo.");
        currentPeriodKey = key;
        db = globalDB[key].programs;
        switchProgram("Baby Program", document.getElementById('link-baby'));
    };

    window.clickCreate = () => {
        const key = `${document.getElementById('cfg-month').value}-${document.getElementById('cfg-year').value}`;
        const theme = prompt("Nombre del Tema para este periodo:");
        if(!theme) return;
        const emptyDB = { "Baby Program": { objectives:[], weeks:[] }, "Tiny Program": { objectives:[], weeks:[] }, "Mini Program": { objectives:[], weeks:[] }, "Big Program": { objectives:[], weeks:[] } };
        globalDB[key] = { theme, programs: emptyDB };
        currentPeriodKey = key;
        db = globalDB[key].programs;
        saveToCloud();
        switchProgram("Baby Program", document.getElementById('link-baby'));
    };

    window.switchProgram = (p, el) => {
        currentProgram = p;
        document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));
        if(el) el.classList.add('active');
        navStack = [{ viewId: 'dashboard' }];
        render();
    };

    function pushView(v, d) { navStack.push({ viewId: v, data: d }); render(); }
    function goBack() { if(navStack.length > 1) { navStack.pop(); render(); } }

    function render() {
        const cur = navStack[navStack.length-1];
        document.querySelectorAll('.view-layer').forEach(l => l.classList.remove('active'));
        document.getElementById(`view-${cur.viewId}`).classList.add('active');
        document.getElementById('btn-back').disabled = navStack.length <= 1;
        document.getElementById('breadcrumbs').innerText = `${currentProgram} > ${cur.viewId.toUpperCase()}`;
        
        if(cur.viewId === 'dashboard') renderDashboard();
        if(cur.viewId === 'groups') renderGroups(cur.data);
        if(cur.viewId === 'activities') renderActivities(cur.data);
        if(cur.viewId === 'activity-detail') renderDetail(cur.data);
    }

    // --- RENDERIZADORES ---
    function renderDashboard() {
        document.getElementById('dash-theme-display').innerText = globalDB[currentPeriodKey].theme;
        document.getElementById('dash-period-display').innerText = currentPeriodKey;
        
        const objC = document.getElementById('objectives-container');
        objC.innerHTML = db[currentProgram].objectives.map((o,i) => `
            <div class="obj-card">
                <div class="edit-controls" style="position:absolute; top:5px; right:5px;">
                    <button class="btn-mini" onclick="editObjective(${i})"><i class="fas fa-pen"></i></button>
                </div>
                <span class="obj-badge">${o.id}</span>
                <div class="obj-text">${o.desc}</div>
            </div>
        `).join('') + `<button class="obj-card" style="border:2px dashed #ccc; display:flex; align-items:center; justify-content:center;" onclick="editObjective()">+ Nuevo Objetivo</button>`;

        const weekC = document.getElementById('weeks-container');
        weekC.innerHTML = db[currentProgram].weeks.map((w,i) => `
            <div class="week-btn-large" onclick="pushView('groups', ${i})">
                <div class="wb-title">${w.id}</div>
                <div class="wb-sub">${w.objId}</div>
            </div>
        `).join('') + `<button class="week-btn-large" style="border:2px dashed #ccc;" onclick="editWeek()">+ Nueva Semana</button>`;
    }

    function renderGroups(idx) {
        currentWeekId = idx;
        const w = db[currentProgram].weeks[idx];
        document.getElementById('groups-week-title').innerText = w.id;
        document.getElementById('groups-week-obj').innerText = `Objetivo: ${w.objId}`;
        
        const acGrid = document.getElementById('academic-grid-container');
        acGrid.innerHTML = (w.academic || []).map((a,i) => `
            <div class="academic-card" style="background:white; padding:1.2rem; border-radius:12px; border:1px solid #e2e8f0;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
                    <strong style="color:var(--baby-color); font-size:0.8rem; text-transform:uppercase;">${a.title}</strong>
                    <button class="btn-mini" onclick="editAcademicContent(${i})"><i class="fas fa-pen"></i></button>
                </div>
                <div style="font-size:0.95rem;">${a.content}</div>
            </div>
        `).join('');

        const grpL = document.getElementById('groups-list-container');
        grpL.innerHTML = (w.groups || []).map((g,i) => `
            <div class="group-card" onclick="pushView('activities', ${i})">
                <div>
                    <h3 style="margin:0;">${g.name}</h3>
                    <small style="color:#64748b;">${g.activities.length} Actividades • ${g.dateStart || ''}</small>
                </div>
                <i class="fas fa-chevron-right"></i>
            </div>
        `).join('');
    }

    function renderActivities(idx) {
        currentGroupId = idx;
        const g = db[currentProgram].weeks[currentWeekId].groups[idx];
        document.getElementById('act-group-name').innerText = g.name;
        document.getElementById('act-meta-info').innerText = `${g.type || 'Contenido Regular'} | Del ${g.dateStart || '?'} al ${g.dateEnd || '?'}`;
        
        document.getElementById('activities-container').innerHTML = g.activities.map((a,i) => `
            <div class="activity-card" onclick="pushView('activity-detail', ${i})">
                <div style="display:flex; align-items:center; gap:15px;">
                    <div class="obj-badge" style="width:30px; height:30px; padding:0; display:flex; align-items:center; justify-content:center;">${i+1}</div>
                    <div>
                        <div style="font-weight:bold;">${a.title}</div>
                        <div style="font-size:0.8rem; color:#64748b;">${a.pillar}</div>
                    </div>
                </div>
                <i class="fas fa-chevron-right" style="color:#cbd5e1;"></i>
            </div>
        `).join('');
    }

    function renderDetail(idx) {
        currentActId = idx;
        const a = db[currentProgram].weeks[currentWeekId].groups[currentGroupId].activities[idx];
        document.getElementById('det-title').innerText = a.title;
        document.getElementById('det-pilar-display').innerText = a.pillar;
        document.getElementById('det-desc').innerHTML = a.desc;
        document.getElementById('det-res-type-badge').innerText = a.resType || "Tablet";
        
        const resBox = document.getElementById('det-res-content');
        if (a.resInputType === 'Link' && a.resLink) {
            resBox.innerHTML = `<a href="${a.resLink}" target="_blank" style="color:var(--primary); font-weight:bold; text-decoration:none;"><i class="fas fa-external-link-alt"></i> Abrir Enlace de Recurso</a>`;
        } else {
            resBox.innerHTML = a.resText || '<span style="color:#94a3b8; font-style:italic;">Sin materiales registrados</span>';
        }

        const statusCont = document.getElementById('det-status-container');
        const st = ["Pendiente", "En Proceso", "Creado"];
        const curSt = a.resourceStatus || "Pendiente";
        statusCont.innerHTML = st.map(s => `<button class="status-btn ${curSt === s ? 'active' : ''}" data-val="${s}" onclick="updateStatus('${s}')">${s}</button>`).join('');
    }

    // --- FUNCIONES EDICIÓN ---
    window.editObjective = (idx = null) => {
        const isNew = idx === null;
        const obj = isNew ? { id: "OBJ 1", desc: "" } : db[currentProgram].objectives[idx];
        let ids = ""; for(let i=1; i<=6; i++) ids += `<option ${obj.id==='OBJ '+i?'selected':''}>OBJ ${i}</option>`;

        const html = `
            <div class="form-group"><label class="label">ID</label><select class="select" id="m-id">${ids}</select></div>
            <div class="form-group"><label class="label">Descripción</label><textarea class="input" id="m-desc" rows="3">${obj.desc}</textarea></div>
        `;
        openModal(isNew?"Nuevo Objetivo":"Editar Objetivo", html, () => {
            const data = { id: document.getElementById('m-id').value, desc: document.getElementById('m-desc').value };
            if(isNew) db[currentProgram].objectives.push(data); else db[currentProgram].objectives[idx] = data;
            render(); saveToCloud();
        });
    };

    window.editWeek = (idx = null) => {
        const isNew = (idx === null && navStack[navStack.length-1].viewId === 'dashboard');
        const realIdx = isNew ? null : currentWeekId;
        const w = isNew ? { id: "Week 01", objId: "OBJ 1" } : db[currentProgram].weeks[realIdx];
        
        let objs = db[currentProgram].objectives.map(o => `<option ${w.objId===o.id?'selected':''}>${o.id}</option>`).join('');
        let ids = ["Week 01", "Week 02", "Week 03", "Week 04", "Week 05"].map(id => `<option ${w.id===id?'selected':''}>${id}</option>`).join('');

        const html = `
            <div class="form-group"><label class="label">ID Semana</label><select class="select" id="m-wid">${ids}</select></div>
            <div class="form-group"><label class="label">Objetivo</label><select class="select" id="m-wobj">${objs}</select></div>
        `;
        openModal("Configurar Semana", html, () => {
            const data = { id: document.getElementById('m-wid').value, objId: document.getElementById('m-wobj').value, academic: w.academic || [], groups: w.groups || [] };
            if(isNew) db[currentProgram].weeks.push(data); else db[currentProgram].weeks[realIdx] = data;
            render(); saveToCloud();
        });
    };

    window.addAcademicContent = () => editAcademicContent(null);
    window.editAcademicContent = (idx) => {
        const isNew = idx === null;
        const item = isNew ? { title: "", content: "" } : db[currentProgram].weeks[currentWeekId].academic[idx];
        const html = `
            <div class="form-group"><label class="label">Título</label><input class="input" id="m-atitle" value="${item.title}"></div>
            <div class="form-group">
                <label class="label">Contenido</label>
                <div class="toolbar"><button class="tool-btn" onclick="document.execCommand('insertUnorderedList')"><i class="fas fa-list"></i></button></div>
                <div class="editor-box" id="m-acont" contenteditable="true">${item.content}</div>
            </div>
        `;
        openModal("Contenido Académico", html, () => {
            const data = { title: document.getElementById('m-atitle').value, content: document.getElementById('m-acont').innerHTML };
            if(!db[currentProgram].weeks[currentWeekId].academic) db[currentProgram].weeks[currentWeekId].academic = [];
            if(isNew) db[currentProgram].weeks[currentWeekId].academic.push(data); else db[currentProgram].weeks[currentWeekId].academic[idx] = data;
            render(); saveToCloud();
        });
    };

    window.addGroup = () => {
        const types = ["Contenido Regular", "Evaluaciones", "Review"].map(t => `<option>${t}</option>`).join('');
        const html = `
            <div class="form-group"><label class="label">Nombre (Días)</label><input class="input" id="m-gname" placeholder="Ej: Lunes y Martes"></div>
            <div class="form-group"><label class="label">Tipo</label><select class="select" id="m-gtype">${types}</select></div>
            <div class="form-group"><label class="label">Lunes de esa semana</label><input type="date" class="input" id="m-gdate" onchange="updateEndDate(this.value)"></div>
            <div class="form-group"><label class="label">Fin de Semana (Auto)</label><input class="input" id="m-gend" disabled></div>
        `;
        openModal("Nuevo Grupo", html, () => {
            const data = { name: document.getElementById('m-gname').value, type: document.getElementById('m-gtype').value, dateStart: document.getElementById('m-gdate').value, dateEnd: document.getElementById('m-gend').value, activities: [] };
            db[currentProgram].weeks[currentWeekId].groups.push(data);
            render(); saveToCloud();
        });
    };

    window.updateEndDate = (val) => {
        if(!val) return;
        let d = new Date(val + "T12:00:00");
        d.setDate(d.getDate() + 5);
        document.getElementById('m-gend').value = d.toISOString().split('T')[0];
    };

    window.addActivity = () => editActivity(true);
    window.editActivity = (isNew = false) => {
        const act = isNew ? { title: "", pillar: "Speaking", desc: "", resType: "Tablet", resInputType: "Link", resLink: "", resText: "" } : db[currentProgram].weeks[currentWeekId].groups[currentGroupId].activities[currentActId];
        const pillars = ["Speaking", "Listening", "Phonics", "Writing"].map(p => `<option ${act.pillar===p?'selected':''}>${p}</option>`).join('');
        
        const html = `
            <div class="form-group"><label class="label">Título</label><input class="input" id="m-title" value="${act.title}"></div>
            <div class="form-group"><label class="label">Pilar</label><select class="select" id="m-pilar">${pillars}</select></div>
            <div class="form-group">
                <label class="label">Descripción / Instrucciones</label>
                <div class="toolbar"><button class="tool-btn" onclick="document.execCommand('bold')">B</button></div>
                <div class="editor-box" id="m-desc" contenteditable="true">${act.desc}</div>
            </div>
            <div class="form-group">
                <label class="label">Entrada de Recurso</label>
                <select class="select" id="m-restype" onchange="document.getElementById('m-link-box').style.display = this.value==='Link'?'block':'none'; document.getElementById('m-text-box').style.display = this.value==='Text'?'block':'none';">
                    <option value="Link" ${act.resInputType==='Link'?'selected':''}>Enlace (URL)</option>
                    <option value="Text" ${act.resInputType==='Text'?'selected':''}>Lista de Texto</option>
                </select>
            </div>
            <div id="m-link-box" style="display:${act.resInputType==='Text'?'none':'block'}"><input class="input" id="m-link" value="${act.resLink||''}" placeholder="https://..."></div>
            <div id="m-text-box" style="display:${act.resInputType==='Text'?'block':'none'}"><div class="editor-box" id="m-text" contenteditable="true">${act.resText||''}</div></div>
        `;
        openModal("Actividad", html, () => {
            const data = { title: document.getElementById('m-title').value, pillar: document.getElementById('m-pilar').value, desc: document.getElementById('m-desc').innerHTML, resInputType: document.getElementById('m-restype').value, resLink: document.getElementById('m-link').value, resText: document.getElementById('m-text') ? document.getElementById('m-text').innerHTML : "", resourceStatus: act.resourceStatus || "Pendiente" };
            if(isNew) db[currentProgram].weeks[currentWeekId].groups[currentGroupId].activities.push(data); else db[currentProgram].weeks[currentWeekId].groups[currentGroupId].activities[currentActId] = data;
            render(); saveToCloud();
        });
    };

    window.updateStatus = (s) => {
        db[currentProgram].weeks[currentWeekId].groups[currentGroupId].activities[currentActId].resourceStatus = s;
        render(); saveToCloud();
    };

    window.editThemeName = () => {
        const theme = prompt("Nuevo nombre del Tema:", globalDB[currentPeriodKey].theme);
        if(theme) { globalDB[currentPeriodKey].theme = theme; render(); saveToCloud(); }
    };

    window.exportBackup = () => {
        const data = {}; data[currentPeriodKey] = globalDB[currentPeriodKey];
        let html = document.documentElement.outerHTML.replace('/* BACKUP_DATA_INJECTION */', `window.isBackupMode=true; window.backupData=${JSON.stringify(data)};`);
        const blob = new Blob([html], {type: 'text/html'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `TK_Backup_${currentPeriodKey}.html`; a.click();
    };

    window.openModal = (t, b, s) => {
        document.getElementById('modal-title').innerText = t;
        document.getElementById('modal-body').innerHTML = b;
        document.getElementById('editor-modal').classList.add('open');
        document.getElementById('modal-save-btn').onclick = () => { s(); closeModal(); };
    };
    window.closeModal = () => document.getElementById('editor-modal').classList.remove('open');
    window.toggleMenu = () => document.getElementById('sidebar').classList.toggle('active');
</script>
</body>
</html>
